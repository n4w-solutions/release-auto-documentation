name: Auto Document Release

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: read

jobs:
  build-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    steps:
      
      ########################################################
      # VERIFICA VARI√ÅVEIS DE AMBIENTE OBRIGAT√ìRIAS
      ########################################################
      
      - name: Validar vari√°veis obrigat√≥rias
        shell: bash
        env:
          SMTP_HOST: ${{ secrets.AUTO_RELEASE_SMTP_HOST }}
          SMTP_PORT: ${{ secrets.AUTO_RELEASE_SMTP_PORT }}
          SMTP_USER: ${{ secrets.AUTO_RELEASE_SMTP_USER }}
          SMTP_PASS: ${{ secrets.AUTO_RELEASE_SMTP_PASS }}
          MAIL_TO: ${{ vars.AUTO_RELEASE_MAIL_TO }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT }}
        run: |
          echo "üîé Validando vari√°veis obrigat√≥rias..."

          missing=0

          check_var () {
            var_name=$1
            var_value=$2

            if [ -z "$var_value" ]; then
              echo "::error::Vari√°vel obrigat√≥ria '$var_name' n√£o est√° configurada."
              missing=1
            fi
          }

          check_var "SMTP_HOST" "$SMTP_HOST"
          check_var "SMTP_PORT" "$SMTP_PORT"
          check_var "SMTP_USER" "$SMTP_USER"
          check_var "SMTP_PASS" "$SMTP_PASS"
          check_var "MAIL_TO" "$MAIL_TO"
          check_var "ENVIRONMENT" "$ENVIRONMENT"

          if [ "$missing" -eq 1 ]; then
            echo ""
            echo "‚ùå Falha na valida√ß√£o."
            echo "Acesse:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi

          echo "‚úÖ Todas as vari√°veis obrigat√≥rias est√£o configuradas."

      ########################################################
      # CHECKOUT DO REPOSIT√ìRIO
      ########################################################

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ########################################################
      # GERA O CONTE√öDO PARA A RELEASE E PARA O EMAIL
      ########################################################

      - name: Generate release notes
        id: notes
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { owner, repo } = context.repo;
            const releaseId = context.payload.release.id;
            const currentTag = context.payload.release.tag_name;

            // Get previous tags (at√© 100)
            const allTags = await github.rest.repos.listTags({
              owner, repo, per_page: 100
            });

            if (allTags.data.length < 2) {
              return "Primeira release ‚Äî sem hist√≥rico anterior.";
            }

            const previousTag = allTags.data[1].name;

            // Get commits between tags
            const commits = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: previousTag,
              head: currentTag
            });

            const items = commits.data.commits.map(c => {
              return `${c.commit.message.split("\n")[0]} ‚Äî ${c.author?.login || c.commit.author.name} (${c.sha.substring(0,7)})`;
            });

            // Categorize by conventional commit types
            const feats = items.filter(i => i.toLowerCase().startsWith("feat"));
            const fixes = items.filter(i => i.toLowerCase().startsWith("fix"));
            const refactors = items.filter(i => i.toLowerCase().startsWith("refactor"));
            const perfs = items.filter(i => i.toLowerCase().startsWith("perf"));
            const chores = items.filter(i => i.toLowerCase().startsWith("chore"));
            const docs = items.filter(i => i.toLowerCase().startsWith("docs"));
            const builds = items.filter(i => i.toLowerCase().startsWith("build"));
            const cis = items.filter(i => i.toLowerCase().startsWith("ci"));
            const configs = items.filter(i => i.toLowerCase().startsWith("config"));
            const deps = items.filter(i => i.toLowerCase().startsWith("deps"));
            const tests = items.filter(i => i.toLowerCase().startsWith("test"));
            const securities = items.filter(i => i.toLowerCase().startsWith("security"));

            const body = `
            # üì¶ Release Notes
            
            ---
            
            ## ‚ú® Highlights da Release
            ${feats.length ? feats.map(f => "‚úîÔ∏è " + f).join("\n") : "_Nenhuma nova feature adicionada nesta vers√£o._"}
            
            ---
            
            ## üêû Corre√ß√µes de Bugs
            ${fixes.length ? fixes.map(f => "ü©π " + f).join("\n") : "_Nenhum bug corrigido nesta release._"}
            
            ---
            
            ## üöÄ Evolu√ß√µes T√©cnicas
            
            ### üîß Refatora√ß√µes
            ${refactors.length ? refactors.map(r => "‚ôªÔ∏è " + r).join("\n") : "_Sem refatora√ß√µes relevantes._"}
            
            ### ‚ö° Performance
            ${perfs.length ? perfs.map(r => "üìà " + r).join("\n") : "_Nenhuma melhoria de performance aplicada._"}
            
            ### üèó Infraestrutura
            ${chores.length ? chores.map(r => "üß± " + r).join("\n") : "_Nenhuma altera√ß√£o de infraestrutura._"}
            
            ### üß© Configura√ß√µes
            ${configs.length ? configs.map(r => "‚öôÔ∏è " + r).join("\n") : "_Sem altera√ß√µes de configura√ß√£o._"}
            
            ### üì¶ Depend√™ncias
            ${deps.length ? deps.map(r => "üìö " + r).join("\n") : "_Nenhuma atualiza√ß√£o de depend√™ncia._"}
            
            ---
            
            ## üîê Seguran√ßa
            ${securities.length ? securities.map(r => "üõ°Ô∏è " + r).join("\n") : "_Nenhuma melhoria ou ajuste de seguran√ßa._"}
            
            ---
            
            ## üß™ Qualidade
            
            ### üß¨ Testes
            ${tests.length ? tests.map(r => "üß™ " + r).join("\n") : "_Nenhuma melhoria em testes automatizados._"}
            
            ### üìù Documenta√ß√£o
            ${docs.length ? docs.map(r => "üìñ " + r).join("\n") : "_Nenhuma atualiza√ß√£o de documenta√ß√£o._"}
            
            ### üèó Build
            ${builds.length ? builds.map(r => "üèóÔ∏è " + r).join("\n") : "_Sem altera√ß√µes no processo de build._"}
            
            ### üîÑ CI/CD
            ${cis.length ? cis.map(r => "üîÑ " + r).join("\n") : "_Pipeline sem altera√ß√µes._"}
            
            ---
            
            ## üßæ Commits Inclu√≠dos
            ${items.map(i => "‚Ä¢ " + i).join("\n")}
            
            ---
            
            ## üìä Metadados da Release
            
            | Item | Valor |
            |------|-------|
            | üè∑ Tag atual | **${currentTag}** |
            | ‚èÆ Tag anterior | **${previousTag}** |
            | üì¶ Total de commits | **${items.length}** |
            
            `;

            return body;

      ########################################################
      # ATUALIZA O BODY DA RELEASE GERADA
      ########################################################

      - name: Update release body
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const releaseId = context.payload.release.id;

            const content = `${{ steps.notes.outputs.result }}`.replace(/`/g, "'");

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: releaseId,
              body: content
            });

      ########################################################
      # CONVERTE PARA HTML ELEGANTE
      ########################################################
      - name: Convert markdown to HTML
        id: html
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const md = `${{ steps.notes.outputs.result }}`;

            const html = `<div style="font-family: Arial, Helvetica, sans-serif; background:#f6f8fa; padding:30px;">
              <div style="max-width:900px; margin:auto; background:white; padding:30px; border-radius:8px;">
                <h1 style="color:#2f80ed;">üöÄ Nova Release Publicada</h1>
                <p><b>Projeto:</b> ${process.env.GITHUB_REPOSITORY}</p>
                <p><b>Tag:</b> ${process.env.GITHUB_REF_NAME}</p>
                <hr/>
                <pre style="white-space: pre-wrap; font-size:14px; line-height:1.5;">
                  ${md}
                </pre>
                <hr/>
                <small style="color:#888">
                  Enviado automaticamente pelo GitHub Actions
                </small>
              </div>
            </div>`;

            return html;

      ########################################################
      # ENVIA EMAIL
      ########################################################
      - name: Send email with release notes
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_HOST }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USER }}
          password: ${{ env.SMTP_PASS }}
          subject: "üöÄ Release ${{ github.event.release.tag_name }} publicada"
          to: ${{ env.MAIL_TO }}
          from: GitHub Actions <${{ env.SMTP_USER }}>
          html_body: ${{ steps.html.outputs.result }}

